{
  "version": 3,
  "sources": ["../../@jeecg/online/useTableSync.js"],
  "sourcesContent": ["var __async = (__this, __arguments, generator) => {\n  return new Promise((resolve, reject) => {\n    var fulfilled = (value) => {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    };\n    var rejected = (value) => {\n      try {\n        step(generator.throw(value));\n      } catch (e) {\n        reject(e);\n      }\n    };\n    var step = (x) => x.done ? resolve(x.value) : Promise.resolve(x.value).then(fulfilled, rejected);\n    step((generator = generator.apply(__this, __arguments)).next());\n  });\n};\nimport { inject, ref, computed, nextTick } from \"vue\";\nimport { V as VALIDATE_FAILED } from \"./cgform.data.js\";\nimport { p as pick } from \"./pick.js\";\nfunction useTableSync(columns) {\n  const tables = inject(\"tables\");\n  const fullScreenRef = inject(\"fullScreenRef\");\n  const tableRef = ref();\n  const loading = ref(false);\n  const dataSource = ref([]);\n  const tableHeight = computed(() => ({\n    normal: (fullScreenRef == null ? void 0 : fullScreenRef.value) ? 430 : 260,\n    noToolbar: (fullScreenRef == null ? void 0 : fullScreenRef.value) ? 480 : 320\n  }));\n  const columnKeys = computed(() => [\"id\"].concat(columns.value.map((col) => col.key)));\n  function validateData(activeKey) {\n    return __async(this, null, function* () {\n      let instance = tableRef.value;\n      let errMap = yield instance.fullValidateTable();\n      if (errMap) {\n        throw { code: VALIDATE_FAILED, activeKey };\n      }\n      let tableData = instance.getTableData().map((data) => pick(data, columnKeys.value));\n      let deleteIds = instance.getDeleteData().map((d) => d.id);\n      return { tableData, deleteIds };\n    });\n  }\n  function setDataSource(data, insert = false) {\n    return __async(this, null, function* () {\n      if (insert) {\n        dataSource.value = [];\n        yield nextTick();\n        yield tableRef.value.addOrInsert(data, 0, null, { setActive: false });\n        yield nextTick();\n        tableRef.value.recalcDisableRows();\n      } else {\n        dataSource.value = data;\n      }\n    });\n  }\n  function syncTable(dbTable) {\n    let targetTable = tableRef.value;\n    let sourceTable = dbTable.value.tableRef;\n    let removeIds = dbTable.value.getRemoveIds();\n    let sourceData = sourceTable.getXTable().internalData.tableFullData;\n    let targetData = targetTable.getXTable().internalData.tableFullData;\n    sourceData.forEach((sourceValue) => {\n      let flag = false;\n      targetData.forEach((targetValue) => {\n        if (sourceValue.id === targetValue.id) {\n          let dbFieldName = targetValue[\"dbFieldName\"];\n          let dbFieldTxt = targetValue[\"dbFieldTxt\"];\n          if (sourceValue.dbFieldName !== dbFieldName || sourceValue.dbFieldTxt !== dbFieldTxt) {\n            targetTable.setValues([{\n              rowKey: targetValue.id,\n              values: {\n                dbFieldName: sourceValue.dbFieldName,\n                dbFieldTxt: sourceValue.dbFieldTxt\n              }\n            }]);\n          }\n          flag = true;\n        } else {\n          removeIds.forEach((deletedId) => {\n            if (deletedId === targetValue.id) {\n              targetTable.removeRowsById(deletedId);\n              flag = true;\n            }\n          });\n        }\n      });\n      if (!flag) {\n        let record = Object.assign({}, sourceValue);\n        columns.value.forEach((column) => {\n          if (column.key !== \"dbFieldName\" && column.key !== \"dbFieldTxt\") {\n            record[column.key] = column.defaultValue;\n          }\n        });\n        targetTable.addRows(record);\n      }\n    });\n    return nextTick();\n  }\n  return { tables, tableRef, loading, dataSource, columnKeys, tableHeight, syncTable, validateData, setDataSource };\n}\nexport { useTableSync as u };\n"],
  "mappings": "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",
  "names": []
}
